apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: prometheus-ns
data:
  prometheus.yml: |
    # 全局配置：采集和规则评估间隔
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    # 告警管理器配置（需填写 Alertmanager 地址）
    alerting:
      alertmanagers:
        - static_configs:
            - targets: ['alertmanager.alertmanager-ns.svc.cluster.local:9093']

    # 告警规则文件路径（需挂载规则文件）
    rule_files: 
      - "/etc/prometheus/rules/*.yml"

    # 采集任务配置
    scrape_configs:

      # 1. 监控 Prometheus 自身
      - job_name: "prometheus"
        static_configs:
          - targets: [ "localhost:9090" ]
            labels:
              app: "prometheus"

      # 2. 采集 Kubelet 指标（/metrics）
      - job_name: 'kubelet'
        kubernetes_sd_configs:
          - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          # 将 Node 的 Label 映射为 Prometheus 标签
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

      # 3. 通过 Service Endpoints 自动发现监控目标（基于 Service 注解）
      - job_name: 'kubernetes-endpoints'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          # 仅保留带有 prometheus.io/scrape=true 注解的 Service
          - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_scrape ]
            action: keep
            regex: true
          # 从注解获取协议（http/https）
          - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_scheme ]
            action: replace
            target_label: __scheme__
            regex: (https?)
          # 从注解获取指标路径（如 /metrics）
          - source_labels: [ __meta_kubernetes_service_annotation_prometheus_io_path ]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          # 从注解获取端口，并拼接成 <IP>:<port>
          - source_labels:
              [ __address__, __meta_kubernetes_service_annotation_prometheus_io_port ]
            action: replace
            target_label: __address__
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
          # 将 Service 的 Label 映射为 Prometheus 标签
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          # 添加命名空间标签
          - source_labels: [ __meta_kubernetes_namespace ]
            action: replace
            target_label: kubernetes_namespace
          # 添加 Service 名称标签
          - source_labels: [ __meta_kubernetes_service_name ]
            action: replace
            target_label: kubernetes_name
          # 添加 Pod 名称标签（来自 Endpoint）
          - source_labels: [ __meta_kubernetes_pod_name ]
            action: replace
            target_label: kubernetes_pod_name

      # 4. 通过 Pod 注解自动发现监控目标（基于 Pod 注解）
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
            namespaces: {}
        # 注意：relabel_configs 是 job 的子项，不是 kubernetes_sd_configs 的子项！
        relabel_configs:
          # 仅保留带有 prometheus.io/scrape=true 注解的 Pod
          - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_scrape ]
            action: keep
            regex: "true"
          # 从 Pod IP 和注解端口构建地址：<podIP>:<port>
          - source_labels:
              [ __meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port ]
            action: replace
            regex: (.+);(.+)
            replacement: $1:$2
            target_label: __address__
          # 从注解获取指标路径
          - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_path ]
            action: replace
            regex: (.+)
            target_label: __metrics_path__
          # 从注解获取协议（http/https）
          - source_labels: [ __meta_kubernetes_pod_annotation_prometheus_io_scheme ]
            action: replace
            regex: (https?)
            target_label: __scheme__
          # 将 Pod 的 Label 映射为 Prometheus 标签
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          # 添加命名空间标签
          - source_labels: [ __meta_kubernetes_namespace ]
            target_label: kubernetes_namespace
          # 添加 Pod 名称标签
          - source_labels: [ __meta_kubernetes_pod_name ]
            target_label: kubernetes_pod_name
          # 添加容器名称标签
          - source_labels: [ __meta_kubernetes_pod_container_name ]
            target_label: kubernetes_container_name

      # 5. 采集 cAdvisor 容器指标（/metrics/cadvisor）
      - job_name: 'cadvisor'
        kubernetes_sd_configs:
          - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          # 将 Node 的 Label 映射为 Prometheus 标签
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          # 修改指标路径为 /metrics/cadvisor
          - replacement: /metrics/cadvisor
            target_label: __metrics_path__

      # 6. 采集 kube-state-metrics 指标
      - job_name: 'kube-state-metrics'
        scrape_interval: 30s
        metrics_path: /metrics
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names:
                - ksm-ns
        relabel_configs:
          # 仅保留 app.kubernetes.io/name=kube-state-metrics 的 Service
          - source_labels: [ __meta_kubernetes_service_label_app_kubernetes_io_name ]
            action: keep
            regex: kube-state-metrics
          # 仅保留名为 http-metrics 的端口
          - source_labels: [ __meta_kubernetes_endpoint_port_name ]
            action: keep
            regex: http-metrics
          # 将 Service 的 Label 映射为 Prometheus 标签
          - action: labelmap
            regex: __meta_kubernetes_service_label_(.+)
          # 添加命名空间标签（重命名为 k8s_namespace）
          - source_labels: [ __meta_kubernetes_namespace ]
            target_label: k8s_namespace
          # 添加 Service 名称标签（重命名为 k8s_sname）
          - source_labels: [ __meta_kubernetes_service_name ]
            target_label: k8s_sname
          # 将 Pod 名称设为 instance 标签（注意：可能覆盖默认 instance）
          - source_labels: [ __meta_kubernetes_pod_name ]
            target_label: instance